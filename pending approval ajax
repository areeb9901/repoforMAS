package com.bnpparibas.beagle.dashboard.actions;

import com.bnpparibas.beagle.ma.ui.SearchResultMasterAgreementDisplay;
import com.bnpparibas.beagle.ma.model.AgreementHelper;
import com.bnpparibas.beagle.ma.indexing.MasterAgreementFields;
import com.bnpparibas.beagle.ma.model.CollateralDocAudit;
import com.bnpparibas.beagle.kernel.util.BeagleDateFormat;

import org.hibernate.Query;

import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;

public class ShowCollateralPendingApprovalRequestsAjax extends ShowCollateralPendingApprovalRequests {

    protected static final String JSON = "json";
    private static final String EXCEL = "excel";

    private String view = JSON;
    private final List<Object[]> parametersList = new ArrayList<Object[]>();

    @Override
    protected void prepareParameters() {
        // same filters as parent
        super.prepareParameters();

        // remove pagination for Ajax "show all"
        parameters.remove("pageIndex");
        parameters.remove("pageSize");
        setPageSize(Integer.MAX_VALUE);
        setPageIndex(1);
    }

    @Override
    protected String postSearch(org.apache.lucene.search.Query query) {

        if (EXCEL.equalsIgnoreCase(getView())) {
            try {
                convertExcel();
            } catch (Exception e) {
                e.printStackTrace();
            }
            return EXCEL;
        }

        return getView();
    }

    private String tryGetter(SearchResultMasterAgreementDisplay sr, String... methodNames) {
        for (String mName : methodNames) {
            try {
                Method m = sr.getClass().getMethod(mName);
                Object val = m.invoke(sr);
                if (val != null) {
                    return val.toString();
                }
            } catch (NoSuchMethodException nsme) {
                // ignore and try next
            } catch (Throwable t) {
                // ignore and try next
            }
        }
        return null;
    }

    /**
     * Get last chased user/date from CollateralDocAudit using segmentId.
     * Reads from LDM_TB_COLL_DOC_AUDIT where:
     *   COLLATERAL_SEGMENT_ID = segmentId
     *   COMMENTS like 'Chased -%'
     * ordered by DATE_AUDIT desc (latest first).
     */
    private String[] getChaseInfoFromAudit(String segmentId) {
        String[] result = new String[] { "", "" };

        if (segmentId == null || segmentId.trim().isEmpty()) {
            return result;
        }

        try {
            Query q = repository.getSession().createQuery(
                    "from CollateralDocAudit a " +
                    "where a.segmentId = :segId " +
                    "  and a.comments like 'Chased -%' " +
                    "order by a.auditDate desc"
            );
            q.setParameter("segId", segmentId);
            q.setMaxResults(1);

            @SuppressWarnings("unchecked")
            List<CollateralDocAudit> list = q.list();
            if (list != null && !list.isEmpty()) {
                CollateralDocAudit a = list.get(0);

                String user = a.getAuditUser();
                String dateStr = "";
                if (a.getAuditDate() != null) {
                    dateStr = BeagleDateFormat.format(a.getAuditDate(), BeagleDateFormat.FORMAT);
                }

                if (user != null) {
                    result[0] = user;
                }
                if (dateStr != null) {
                    result[1] = dateStr;
                }

                // debug: you can remove later if you want
                System.out.println("SEG=" + segmentId + " -> user=" + result[0] + ", date=" + result[1]);
            } else {
                System.out.println("SEG=" + segmentId + " -> no chase audit found");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        return result;
    }

    /**
     * Build the flat list backing the DataTables grid on the "Show all" page.
     *
     * Object[] row indexes:
     *  0 - Agreement ID
     *  1 - Group
     *  2 - Collateral Segment Id
     *  3 - Agreement Type (cleaned)
     *  4 - Standard / doc class text
     *  5 - Document Category
     *  6 - CRDS Code
     *  7 - CP LEI
     *  8 - Counterparty Entity (Excel display)
     *  9 - Creation Date
     * 10 - CMO Location
     * 11 - Comments (from segData[4])
     * 12 - Doc Id
     * 13 - Chased User  (from audit)
     * 14 - Chased Date  (from audit)
     */
    private void buildFullListFromRawSegments() {

        try {
            parametersList.clear();

            String actionName = "";
            if (parameters.get("collateralDocumentStatus") != null) {
                String[] actions = (String[]) parameters.get("collateralDocumentStatus");
                if (actions.length > 0) {
                    actionName = actions[0];
                }
            }

            List<SearchResultMasterAgreementDisplay> results = getMasterAgreementsDisplay();

            for (SearchResultMasterAgreementDisplay sr : results) {

                String segIdCombined = sr.getSegId();
                if (segIdCombined == null || segIdCombined.trim().isEmpty()) {
                    continue;
                }

                String[] collateralDataArray = segIdCombined.split("#_#");

                for (String segRaw : collateralDataArray) {

                    String[] segData = segRaw != null ? segRaw.split("\\$_\\$") : new String[]{};
                    if (segData.length == 0 || "".equals(segData[0])) {
                        continue;
                    }

                    String segStatus = segData.length > 5 ? segData[5] : "";
                    if (!"PendingFinalApproval".equalsIgnoreCase(segStatus)) {
                        continue;
                    }

                    if (!AgreementHelper.checkFilterContains(segData, MasterAgreementFields.CMO_LOCATION, parameters)) {
                        continue;
                    }

                    if (!AgreementHelper.checkFilterContains(segData, MasterAgreementFields.CMO_USER, parameters)) {
                        continue;
                    }

                    if (!AgreementHelper.checkFilterContains(segData, MasterAgreementFields.COLLATERAL_DOCUMENT_CATEGORY, parameters)) {
                        continue;
                    }

                    if (!AgreementHelper.isShowMyItemOnCollDashboard(segData, userRoleForShowMyItem, getUser(), collAdminLocation)) {
                        continue;
                    }

                    Object[] r = new Object[15];
                    int i = 0;

                    // 0 - Agreement ID
                    r[i++] = sr.getAgreementId();

                    // 1 - Group
                    r[i++] = sr.getGroup();

                    // 2 - Collateral Segment Id
                    String segmentId = segData.length > 0 ? segData[0] : "";
                    r[i++] = segmentId;

                    // 3 - Agreement Type (cleaned)
                    String type = sr.getType();
                    String cleanedType = "";
                    if (type != null) {
                        cleanedType = type.replaceFirst("[/(]+[0-9]+[/)]+", "");
                    }
                    r[i++] = cleanedType == null ? "" : cleanedType;

                    // 4 - Standard / doc class text
                    r[i++] = segData.length > 2 ? segData[2] : "";

                    // 5 - Document Category
                    r[i++] = getCollateralDocumentCategory(segData.length > 1 ? segData[1] : "");

                    // 6 - CRDS Code
                    r[i++] = sr.getCounterpartyEntityMarketPlayerCode() == null
                            ? ""
                            : sr.getCounterpartyEntityMarketPlayerCode();

                    // 7 - CP LEI
                    r[i++] = sr.getCpLei() == null ? "" : sr.getCpLei();

                    // 8 - Counterparty Entity (Excel)
                    r[i++] = sr.getCounterpartyEntityExcel() == null
                            ? ""
                            : sr.getCounterpartyEntityExcel();

                    // 9 - Creation Date
                    String creationDate = null;
                    if (segData.length > 9 && segData[9] != null && segData[9].trim().length() > 0) {
                        creationDate = segData[9];
                    } else {
                        creationDate = tryGetter(sr,
                                "getDocStartDate",
                                "getDocCreateDate",
                                "getCreationDate",
                                "getDocCreateDateForAgreement",
                                "getDocCreateDateFormatted");
                    }
                    r[i++] = creationDate == null ? "" : creationDate;

                    // 10 - CMO Location
                    r[i++] = segData.length > 6 ? segData[6] : "";

                    // 11 - Comments
                    r[i++] = segData.length > 4 ? segData[4] : "";

                    // 12 - Doc Id
                    String docId = "";
                    if (segData.length > 13 && segData[13] != null && segData[13].matches("\\d+")) {
                        docId = segData[13].trim();
                    } else {
                        docId = tryGetter(sr, "getDocId", "getDocumentId", "getDocument", "getDocIdentifier");
                        if (docId == null || !docId.matches("\\d+")) {
                            docId = "";
                        }
                    }
                    r[i++] = docId;

                    // 13 / 14 - Chased User / Chased Date from audit
                    String[] chaseInfo = getChaseInfoFromAudit(segmentId);
                    String chasedUser = chaseInfo[0];
                    String chasedDate = chaseInfo[1];

                    r[i++] = chasedUser == null ? "" : chasedUser;  // 13
                    r[i++] = chasedDate == null ? "" : chasedDate;  // 14

                    parametersList.add(r);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public List<Object[]> getParametersList() {
        if (parametersList.isEmpty() && !EXCEL.equalsIgnoreCase(view)) {
            buildFullListFromRawSegments();
        }
        return parametersList;
    }

    public String getView() {
        return view;
    }

    public void setView(String view) {
        this.view = view;
    }
}
