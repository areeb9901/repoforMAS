package com.bnpparibas.beagle.dashboard.actions;

import com.bnpparibas.beagle.ma.ui.SearchResultMasterAgreementDisplay;
import com.bnpparibas.beagle.ma.model.AgreementHelper;
import com.bnpparibas.beagle.ma.indexing.MasterAgreementFields;
import com.bnpparibas.beagle.ma.model.CollateralDocStatusDetails;
import com.bnpparibas.beagle.ma.model.MasterAgreement;

import org.hibernate.Query;

import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.List;

public class ShowCollateralPendingApprovalRequestsAjax extends ShowCollateralPendingApprovalRequests {

    protected static final String JSON = "json";
    private static final String EXCEL = "excel";

    private String view = JSON;
    private final List<Object[]> parametersList = new ArrayList<>();

    @Override
    protected void prepareParameters() {
        // same filters as ShowCollateralPendingApprovalRequests,
        // but for Ajax we want ALL rows (no paging)
        super.prepareParameters();

        // remove pagination and override page size
        parameters.remove("pageIndex");
        parameters.remove("pageSize");
        setPageSize(Integer.MAX_VALUE);
        setPageIndex(1);
    }

    @Override
    protected String postSearch(org.apache.lucene.search.Query query) {

        if (EXCEL.equalsIgnoreCase(getView())) {
            try {
                convertExcel();
            } catch (Exception e) {
                e.printStackTrace();
            }
            return EXCEL;
        }

        return getView();
    }

    private String tryGetter(SearchResultMasterAgreementDisplay sr, String... methodNames) {
        for (String mName : methodNames) {
            try {
                Method m = sr.getClass().getMethod(mName);
                Object val = m.invoke(sr);
                if (val != null) return val.toString();
            } catch (NoSuchMethodException nsme) {
                // ignore and try next
            } catch (Throwable t) {
                // ignore and try next
            }
        }
        return null;
    }

    /**
     * Get chasedUser / chasedDate from CollateralDocStatusDetails using MA + segmentId.
     * This is the same source of truth the smaller dashboard view relies on.
     */
    private String[] getChaseInfoFromStatusDetails(Long maId, String segmentId) {
        String[] result = new String[] { "", "" };

        if (maId == null || segmentId == null || segmentId.trim().isEmpty()) {
            return result;
        }

        try {
            // Load the MasterAgreement entity
            MasterAgreement ma = (MasterAgreement) repository.findObject(MasterAgreement.class, maId);
            if (ma == null) {
                return result;
            }

            // Find the status details row for this MA + segment
            Query q = repository.getSession().createQuery(
                "from CollateralDocStatusDetails cd " +
                "where cd.key.ma = :ma and cd.collateralSegmentId = :segId"
            );
            q.setParameter("ma", ma);
            q.setParameter("segId", segmentId);

            @SuppressWarnings("unchecked")
            List<CollateralDocStatusDetails> list = q.list();

            if (list != null && !list.isEmpty()) {
                CollateralDocStatusDetails cd = list.get(0);

                if (cd.getChasedUser() != null) {
                    result[0] = cd.getChasedUser();
                }
                if (cd.getChasedDate() != null) {
                    result[1] = cd.getChasedDate();
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        return result;
    }

    /**
     * Build the full flat list used by the DataTables grid on the "Show all" page.
     * Each Object[] row has 15 elements:
     *
     *  0 - Agreement ID
     *  1 - Group
     *  2 - Collateral Segment Id
     *  3 - Agreement Type (cleaned)
     *  4 - Standard / Doc class text
     *  5 - Document Category
     *  6 - CRDS Code
     *  7 - CP LEI
     *  8 - Counterparty Entity (Excel display)
     *  9 - Creation Date
     * 10 - CMO Location
     * 11 - Comments (from segData[4] in original logic)
     * 12 - Doc Id
     * 13 - Chased User
     * 14 - Chased Date
     */
    private void buildFullListFromRawSegments() {

        try {
            parametersList.clear();

            String actionName = "";
            if (parameters.get("collateralDocumentStatus") != null) {
                String[] actions = (String[]) parameters.get("collateralDocumentStatus");
                if (actions.length > 0) {
                    actionName = actions[0];
                }
            }

            List<SearchResultMasterAgreementDisplay> results = getMasterAgreementsDisplay();

            for (SearchResultMasterAgreementDisplay sr : results) {

                String segIdCombined = sr.getSegId();
                if (segIdCombined == null || segIdCombined.trim().isEmpty()) continue;

                String[] collateralDataArray = segIdCombined.split("#_#");

                for (String segRaw : collateralDataArray) {

                    String[] segData = segRaw != null ? segRaw.split("\\$_\\$") : new String[]{};
                    if (segData.length == 0 || "".equals(segData[0])) continue;

                    String segStatus = segData.length > 5 ? segData[5] : "";
                    if (!"PendingFinalApproval".equalsIgnoreCase(segStatus)) continue;

                    if (!AgreementHelper.checkFilterContains(segData, MasterAgreementFields.CMO_LOCATION, parameters))
                        continue;

                    if (!AgreementHelper.checkFilterContains(segData, MasterAgreementFields.CMO_USER, parameters))
                        continue;

                    if (!AgreementHelper.checkFilterContains(segData, MasterAgreementFields.COLLATERAL_DOCUMENT_CATEGORY, parameters))
                        continue;

                    if (!AgreementHelper.isShowMyItemOnCollDashboard(segData, userRoleForShowMyItem, getUser(), collAdminLocation))
                        continue;

                    Object[] r = new Object[15];
                    int i = 0;

                    Long maId = sr.getAgreementId();

                    r[i++] = maId;                      // 0 agreementId
                    r[i++] = sr.getGroup();             // 1 group

                    String segmentId = segData.length > 0 ? segData[0] : "";
                    r[i++] = segmentId;                 // 2 segmentId

                    String type = sr.getType();
                    String cleanedType = "";
                    if (type != null) {
                        cleanedType = type.replaceFirst("[/(]+[0-9]+[/)]+", "");
                    }
                    r[i++] = cleanedType == null ? "" : cleanedType;   // 3 agreement type

                    r[i++] = segData.length > 2 ? segData[2] : "";     // 4 standard/doc class
                    r[i++] = getCollateralDocumentCategory(segData.length > 1 ? segData[1] : "");  // 5 doc category

                    r[i++] = sr.getCounterpartyEntityMarketPlayerCode() == null
                            ? ""
                            : sr.getCounterpartyEntityMarketPlayerCode();    // 6 CRDS code

                    r[i++] = sr.getCpLei() == null ? "" : sr.getCpLei();     // 7 CP LEI

                    r[i++] = sr.getCounterpartyEntityExcel() == null
                            ? ""
                            : sr.getCounterpartyEntityExcel();               // 8 counterparty

                    String creationDate = null;
                    if (segData.length > 9 && segData[9] != null && segData[9].trim().length() > 0) {
                        creationDate = segData[9];
                    } else {
                        creationDate = tryGetter(sr,
                                "getDocStartDate",
                                "getDocCreateDate",
                                "getCreationDate",
                                "getDocCreateDateForAgreement",
                                "getDocCreateDateFormatted");
                    }
                    r[i++] = creationDate == null ? "" : creationDate;       // 9 creation date

                    r[i++] = segData.length > 6 ? segData[6] : "";           // 10 CMO location
                    r[i++] = segData.length > 4 ? segData[4] : "";           // 11 comments (from segData[4])

                    // ------------- DocId (12) -------------
                    String docId = "";
                    if (segData.length > 13 && segData[13] != null && segData[13].matches("\\d+")) {
                        docId = segData[13].trim();
                    } else {
                        docId = tryGetter(sr, "getDocId", "getDocumentId", "getDocument", "getDocIdentifier");
                        if (docId == null || !docId.matches("\\d+")) {
                            docId = "";
                        }
                    }
                    r[i++] = docId;                                        // 12

                    // ------------- ChasedUser / ChasedDate (13,14) -------------
                    String[] chaseInfo = getChaseInfoFromStatusDetails(maId, segmentId);
                    String chasedUser = chaseInfo[0];
                    String chasedDate = chaseInfo[1];

                    r[i++] = chasedUser == null ? "" : chasedUser;         // 13
                    r[i++] = chasedDate == null ? "" : chasedDate;         // 14

                    parametersList.add(r);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public List<Object[]> getParametersList() {
        if (parametersList.isEmpty() && !EXCEL.equalsIgnoreCase(view)) {
            buildFullListFromRawSegments();
        }
        return parametersList;
    }

    public String getView() {
        return view;
    }

    public void setView(String view) {
        this.view = view;
    }
}
