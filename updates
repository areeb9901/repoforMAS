#macro (renderButton $n $ma_id)
  #if($action.isCanRedirect())
    <button id="redirectLoc_$ma_id" value="$ma_id" name="$n" class="redirectClass button-bnp button-bnp-raised button-bnp-info button-bnp-xs">Redirect</button>
  #elseif($action.isCanChase())
    <button id="chaseRequest" value="$ma_id" name="$n" class="chaseClass button-bnp button-bnp-raised button-bnp-info button-bnp-xs">Chase</button>
  #end
#end

## we'll fetch data via ajax from ShowCollateralPendingApprovalRequestsAjax (same as show-all).
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="stylesheet" href="$request.contextPath/js/jquery-ui-1.11.4/css/smoothness/jquery-ui.css?ver=1.0"/>
</head>

<script type="text/javascript">
  var j = jQuery;
  jQuery.noConflict();
</script>

<input type="hidden" id="PendingSize" name="totalPendingSize" value="$action.getCollateralStatusDisplay(5).size()">

<div class="card card-bnp-home card-low-shadow">
  <div class="card-header card-header-portlets card-border card-header-md-bnp">
    <a href="#" data-toggle="collapse">
      <div class="card-title">
        <span class="a-link-bnp"><i class="material-icons">event</i>Pending Final Approval Requests</span>
      </div>
    </a>
  </div>

  <div id="PendingFinalApproval" class="card-body card-body-low-padding">

    <table id="PendingFinalApprovalTable" class="table table-bnp table-responsive table-responsive-md table-bordered" style="width: 100%; table-layout: fixed;">
      <thead>
        <tr>
          <th>Agreement</th>
          <th>Group</th>
          <th>Collateral Segment Id</th>
          <th>Agreement Type</th>
          <th>Standard</th>
          <th>Document Category</th>
          <th>CRDS Code</th>
          <th>LEI Number</th>
          <th>Counterparty</th>
          <th>Creation Date</th>
          <th>CMO Location</th>
          <th>Action</th>
          <th>Comments</th>
        </tr>
      </thead>
    </table>

  </div>
</div>

<div id="locationRedirect" title="Redirect CMO Location" style="display:none;">
  <form action="RedirectCmoLocation.action" method="post" name="redirectLocationForm" id="redirectLocation" autocomplete="off">
    <div style="padding-top: 10px">
      <table>
        <tr><td><input type="radio" name="cmoLocation" value="LON"></td><td>LONDON</td></tr>
        <tr><td><input type="radio" name="cmoLocation" value="BRU"></td><td>BRUSSELS</td></tr>
        <tr><td><input type="radio" name="cmoLocation" value="HKG"></td><td>HONG KONG</td></tr>
        <tr><td><input type="radio" name="cmoLocation" value="NYK"></td><td>NEW YORK</td></tr>
      </table>
    </div>
  </form>
</div>

<div id="chase" title="Chase PFA request" style="display:none;">
  <form action="ChasePFA.action" method="post" name="chaseForm" id="chaseForm">
    <div style="padding-top: 10px"><pre>Do you want to proceed?</pre></div>
  </form>
</div>

<script type="text/javascript">
j(document).ready(function () {
  // fetch data via the same ajax action used by your show-all page
  j.ajax({
    url: '${request.contextPath}/secure/CollateralPendingApprovalRequestsAjax.action?view=json',
    type: 'POST',
    beforeSend: function () {
      jquery_block_ui();
    },
    success: function (data) {
      // data.parametersList is expected (as in the show-all action)
      initPendingFinalApprovalTable(data.parametersList || []);
    },
    complete: function () {
      j.unblockUI();
    },
    error: function (xhr, status, err) {
      console.error('Failed loading pending approval data:', xhr);
      j.unblockUI();
    }
  });

  // helper to robustly parse date strings for sorting
  function parseDdMmmYyyyToTs(dateStr) {
    if (!dateStr) return 0;
    dateStr = j.trim(String(dateStr));
    if (dateStr === '' || dateStr === 'null' || dateStr === undefined) return 0;
    dateStr = dateStr.replace(/\s+/g, ' ').replace(/--+/g, '-').trim();
    var months = { jan:0, feb:1, mar:2, apr:3, may:4, jun:5, jul:6, aug:7, sep:8, oct:9, nov:10, dec:11 };
    var parts = dateStr.split('-');
    if (parts.length !== 3) return 0;
    var day = parseInt(parts[0], 10);
    var monStr = parts[1].substring(0,3).toLowerCase();
    var month = months[monStr];
    var year = parseInt(parts[2], 10);
    if (isNaN(day) || isNaN(month) || isNaN(year)) return 0;
    return new Date(year, month, day).getTime();
  }

  // initialise DataTable exactly like show-all page; only difference: show 5 rows (client-side)
  function initPendingFinalApprovalTable(data) {
    // destroy if exists
    if (j.fn.DataTable.isDataTable('#PendingFinalApprovalTable')) {
      j('#PendingFinalApprovalTable').DataTable().clear().destroy();
    }

    j('#PendingFinalApprovalTable').DataTable({
      data: data,
      pageLength: 5,
      paging: false, // dashboard shows top 5 only (no pagination in portlet)
      searching: false,
      info: false,
      columns: [
        {
          data: 0,
          render: function (d) {
            return "<a href='" + "$request.contextPath" + "/secure/ShowMasterAgreement.action?masterAgreementId=" + d + "&view=#COLLATERAL'><font class='a-link-table-bnp'>" + d + "</font></a>";
          }
        },
        { data: 1 },
        { data: 2 },
        { data: 3 },
        { data: 4 },
        { data: 5 },
        { data: 6, orderable: true },
        { data: 7 },
        { data: 8, orderable: true },
        {
          data: 9,
          render: function (data, type) {
            if (type === 'sort' || type === 'type') return parseDdMmmYyyyToTs(data);
            return data;
          },
          orderable: true
        },
        {
          data: 10,
          render: function (data, type, row) {
            // strip any leading [CODE] prefix from the cmoLocation (so it shows "Hong Kong" rather than "[HKG] Hong Kong")
            var display = data ? String(data).replace(/\[[^\]]+\]\s*/g, '') : '';
            var chasedUser = row[13] || '';
            var chasedDate = row[14] || '';
            if (chasedUser && chasedUser.trim() !== '') {
              display += "<br/>Last Chased By : " + chasedUser + "<br/>On : " + chasedDate;
            }
            return display;
          },
          orderable: true
        },
        {
          data: null,
          render: function (row) {
            var maId = row[0], segId = row[2], cmoLoc = row[10];
            var docId = row[12] || ('doc_' + maId + '_' + segId);
            var userType = (j("#userType").val() || "");
            // build buttons similar to show-all: buttons are shown depending on role on backend
            if (userType === 'collateralOpsUser') {
              return "<button class='redirectClass button-bnp button-bnp-raised button-bnp-info button-bnp-xs' data-maid='" + maId + "' data-docid='" + docId + "' value='" + segId + "' name='" + cmoLoc + "'>Redirect</button>";
            } else if (userType === 'legalUser') {
              return "<button class='chaseClass button-bnp button-bnp-raised button-bnp-info button-bnp-xs' data-maid='" + maId + "' data-docid='" + docId + "' value='" + segId + "' name='" + cmoLoc + "'>Chase</button>";
            } else {
              return "";
            }
          }
        },
        { data: 11 }
      ],
      createdRow: function(row, data) {
        var docId = data[12];
        if (docId && docId.toString().trim() !== '') {
          j(row).attr('id', docId);
        } else {
          var maId = data[0] || '';
          var segId = data[2] || '';
          j(row).attr('id', 'doc_' + maId + '_' + segId);
        }
      },
      order: [[9, 'asc']],
      autoWidth: false,
      responsive: true
    });
  }

  // --- Chase handler (updates datatable row on success)
  j(document).off('click', '.chaseClass').on('click', '.chaseClass', function () {
    var $btn = j(this);
    var ma_id = $btn.data('maid');
    var collateralSegment_Id = $btn.val();
    var doc_id = $btn.data('docid') || 0;

    j.confirm({
      title: 'Chase PFA request',
      content: 'Do you want to proceed?',
      buttons: {
        "Yes": function () {
          j.ajax({
            url: '$request.contextPath/secure/ChasePFA.ajax?masterAgreementId=' + encodeURIComponent(ma_id)
                 + '&collateralSegmentId=' + encodeURIComponent(collateralSegment_Id)
                 + '&documentId=' + encodeURIComponent(doc_id),
            type: 'POST',
            success: function (resp) {
              console.log("Chase Response:", resp);
              j.confirm({
                title: 'Alert!',
                content: 'Email sent to CMO',
                buttons: {
                  "OK": function () {
                    if (resp && resp.cmoLocationText) {
                      // update DataTable row in-place
                      var table = j('#PendingFinalApprovalTable').DataTable();
                      var row = table.row('#' + CSS.escape(doc_id));
                      if (row && row.length) {
                        var rowData = row.data();
                        // keep chased user/date columns consistent with how show-all expects them
                        rowData[10] = (String(resp.cmoLocationText || '')).replace(/\[[^\]]+\]\s*/g, '');
                        // if server returns chasedUser/chasedDate fields, place them in indices 13/14 if present
                        if (resp.chasedUser) rowData[13] = resp.chasedUser;
                        if (resp.chasedDate) rowData[14] = resp.chasedDate;
                        row.data(rowData).invalidate().draw(false);
                      } else {
                        // fallback: refresh the portlet table
                        location.reload();
                      }
                    } else {
                      location.reload();
                    }
                  }
                }
              });
            },
            error: function (xhr) {
              console.error('Chase Error:', xhr);
              j.alert("Error occurred while chasing request.");
            }
          });
        },
        "No": function () {}
      }
    });
  });

  // --- Redirect handler (updates datatable row on success)
  j(document).off('click', '.redirectClass').on('click', '.redirectClass', function () {
    var $btn = j(this);
    var ma_id = $btn.data('maid');
    var collateralSegment_Id = $btn.val();
    var doc_id = $btn.data('docid') || 0;

    j.confirm({
      title: 'Redirect CMO Location',
      content:
        '<table>' +
          '<tr><td><input type="radio" id="london" name="cmoLocation" value="LON"></td><td>LONDON</td></tr>' +
          '<tr><td><input type="radio" id="brussels" name="cmoLocation" value="BRU"></td><td>BRUSSELS</td></tr>' +
          '<tr><td><input type="radio" id="hongkong" name="cmoLocation" value="HKG"></td><td>HONG KONG</td></tr>' +
          '<tr><td><input type="radio" id="newyork" name="cmoLocation" value="NYK"></td><td>NEW YORK</td></tr>' +
        '</table>',
      buttons: {
        "Yes": function () {
          var cmo_loc = j('input:radio[name="cmoLocation"]:checked').val();
          j.ajax({
            url: '$request.contextPath/secure/RedirectCmoLocation.ajax?masterAgreementId=' + encodeURIComponent(ma_id)
                 + '&cmoLocation=' + encodeURIComponent(cmo_loc)
                 + '&collateralSegmentId=' + encodeURIComponent(collateralSegment_Id)
                 + '&documentId=' + encodeURIComponent(doc_id),
            type: 'POST',
            success: function (resp) {
              j.confirm({
                title: 'Alert!',
                content: 'Request redirected and an email has been sent to CMO',
                buttons: {
                  "OK": function () {
                    if (resp && resp.cmoLocationText) {
                      // Update the cell directly in DataTable row
                      var table = j('#PendingFinalApprovalTable').DataTable();
                      var row = table.row('#' + CSS.escape(doc_id));
                      if (row && row.length) {
                        var rowData = row.data();
                        rowData[10] = String(resp.cmoLocationText || '').replace(/\[[^\]]+\]\s*/g, '');
                        row.data(rowData).invalidate().draw(false);
                      } else {
                        location.reload();
                      }
                    } else {
                      location.reload();
                    }
                  }
                }
              });
            },
            error: function (xhr) {
              console.error('Redirect Error:', xhr);
            }
          });
        },
        "No": function () {}
      }
    });
  });

}); // end document.ready
</script>

<!-- Excel export modal / other supporting UI remain untouched (retain from your current vm) -->
<div id="excelExportPopup" class="modal fade" role="dialog">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header modal-header-home ">
        <h4 class="modal-title font-weight-bold"><i class="material-icons md-24 icon-white">open_in_browser</i> Excel Export</h4>
        <a title="Close" data-dismiss="modal"><i class="material-icons icon-white">close</i></a>
      </div>
      <div class="modal-body">
        <form id="excelExport" name="excelExport" action="${request.requestURI.replaceAll('.action', '.ajax')}" method="post">
          <input type='hidden' name='view' value='excel'/>
          #foreach($param in $parameterNames)
            #foreach($paramValue in ${action.getParameterValues($param)})
              <input type='hidden' name='${param}' value='$paramValue'/>
            #end
          #end
        </form>
      </div>
      <div class="modal-footer">
        <button id="export" type="button" class="button-bnp button-bnp-raised button-bnp-info button-bnp-xs" data-dismiss="modal">
          <i class="fas fa-download"></i> Export To Excel
        </button>
      </div>
    </div>
  </div>
</div>
