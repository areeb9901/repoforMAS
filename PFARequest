package com.bnpparibas.beagle.documents;

import com.bnpparibas.beagle.kernel.util.BeagleDateFormat;
import com.bnpparibas.beagle.ma.model.CollateralDocStatusDetails;
import com.bnpparibas.beagle.ma.model.NegotiationDocument;
import com.bnpparibas.beagle.staticdata.model.User;
import java.util.Date;

/**
 * Handles Chase PFA Request for Pending Final Approval (AJAX version)
 */
public class ChasePFARequest extends PendingCollateralRequestAction {

    private Long documentId;

    public Long getDocumentId() {
        return documentId;
    }

    public void setDocumentId(Long documentId) {
        this.documentId = documentId;
    }

    @Override
    public String doExecute() {
        super.doExecute();
        chaseRequest();
        return SUCCESS;
    }

    @Override
    protected String executeMasterAgreementAction() {
        return SUCCESS;
    }

    private void chaseRequest() {
        try {
            // ✅ Retrieve entities
            CollateralDocStatusDetails collateralDocStatusDetails =
                    getCollateralDocStatusDetails(collateralSegmentId, documentId);
            NegotiationDocument negotiationDocument =
                    getNegotiationDoc(masterAgreement, collateralDocStatusDetails);
            User currentUser = getUser();

            // ✅ Update chased info — this was missing in your AJAX version
            String formattedDate = BeagleDateFormat.format(new Date(), BeagleDateFormat.FORMAT);
            collateralDocStatusDetails.setChasedUser(currentUser.getFullname());
            collateralDocStatusDetails.setChasedDate(formattedDate);

            // ✅ Persist the chase info so it stays after reload
            repository.saveOrUpdate(collateralDocStatusDetails);
            repository.getSession().flush();

            // ✅ Proceed with standard audit + mail + reindex (same as original)
            String negotiator = negotiationDocument.getNegotiator() != null
                    ? negotiationDocument.getNegotiator().getFullName()
                    : "Unknown";

            emailComments = negotiationDocument.getEmailNotificationsComments();

            collateralOpsService.createAuditLogForRedirectChase(
                    negotiationDocument, currentUser, masterAgreement, collateralDocStatusDetails, "", "chase"
            );

            super.sendRedirectMail(
                    buildMailBody(negotiator, collateralSegmentId).toString(),
                    negotiationDocument,
                    collateralDocStatusDetails,
                    ""
            );

            collateralOpsService.reindexMA(masterAgreement);

            System.out.println("CHASE SUCCESS: persisted chase info and audit for docId=" + documentId);

        } catch (Exception e) {
            e.printStackTrace();
            System.err.println("Error in ChasePFARequest: " + e.getMessage());
        }
    }

    @Override
    public StringBuilder buildMailBody(String negotiator, String collateralSegmentId) {
        StringBuilder mailBody = new StringBuilder();
        mailBody.append("All,\n\n")
                .append(super.buildMailBody(negotiator, collateralSegmentId));
        return mailBody;
    }
}
