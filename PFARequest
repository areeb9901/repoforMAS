package com.bnpparibas.beagle.documents;

import com.bnpparibas.beagle.kernel.util.BeagleDateFormat;
import com.bnpparibas.beagle.ma.model.CollateralDocStatusDetails;
import com.bnpparibas.beagle.ma.model.NegotiationDocument;
import com.bnpparibas.beagle.staticdata.model.User;

import org.apache.struts2.ServletActionContext;
import org.json.JSONObject;

import javax.servlet.http.HttpServletResponse;
import java.text.SimpleDateFormat;
import java.util.Date;

/**
 * Handles Chase PFA Request for Pending Final Approval (AJAX version)
 * Persists chase info, audit, reindex, and responds with JSON.
 */
public class ChasePFARequest extends PendingCollateralRequestAction {

    private Long documentId;

    public Long getDocumentId() {
        return documentId;
    }

    public void setDocumentId(Long documentId) {
        this.documentId = documentId;
    }

    @Override
    public String doExecute() {
        super.doExecute();
        try {
            chaseRequest();
        } catch (Exception e) {
            e.printStackTrace();
            writeErrorResponse("Error occurred while chasing request: " + e.getMessage());
        }
        return null; // handled via JSON response
    }

    @Override
    protected String executeMasterAgreementAction() {
        return SUCCESS;
    }

    /**
     * Main chase logic: update chase info, log, mail, reindex, and respond.
     */
    private void chaseRequest() {
        try {
            // Fetch details
            CollateralDocStatusDetails collateralDocStatusDetails =
                    getCollateralDocStatusDetails(collateralSegmentId, documentId);
            NegotiationDocument negotiationDocument =
                    getNegotiationDoc(masterAgreement, collateralDocStatusDetails);
            User currentUser = getUser();

            // Update chased info (to persist in DB)
            String formattedDate = BeagleDateFormat.format(new Date(), BeagleDateFormat.FORMAT);
            collateralDocStatusDetails.setChasedUser(currentUser.getFullname());
            collateralDocStatusDetails.setChasedDate(formattedDate);

            // Persist to DB
            repository.saveOrUpdate(collateralDocStatusDetails);
            repository.getSession().flush();

            // Create audit entry (same as before)
            collateralOpsService.createAuditLogForRedirectChase(
                    negotiationDocument, currentUser, masterAgreement,
                    collateralDocStatusDetails, "", "chase"
            );

            // Send notification mail
            String negotiatorName = (negotiationDocument.getNegotiator() != null)
                    ? negotiationDocument.getNegotiator().getFullName()
                    : "Unknown";

            super.sendRedirectMail(
                    buildMailBody(negotiatorName, collateralSegmentId).toString(),
                    negotiationDocument,
                    collateralDocStatusDetails,
                    ""
            );

            // Reindex for updated view
            collateralOpsService.reindexMA(masterAgreement);

            // Write JSON response for AJAX DataTable
            writeSuccessResponse(currentUser.getFullname(), formattedDate);

            System.out.println("CHASE SUCCESS for docId=" + documentId +
                    " by " + currentUser.getFullname() +
                    " on " + formattedDate);

        } catch (Exception e) {
            e.printStackTrace();
            writeErrorResponse("Chase request failed: " + e.getMessage());
        }
    }

    @Override
    public StringBuilder buildMailBody(String negotiator, String collateralSegmentId) {
        StringBuilder mailBody = new StringBuilder();
        mailBody.append("All,\n\n")
                .append(super.buildMailBody(negotiator, collateralSegmentId));
        return mailBody;
    }

    /**
     * Write JSON success response for AJAX
     */
    private void writeSuccessResponse(String userName, String date) {
        try {
            HttpServletResponse response = ServletActionContext.getResponse();
            response.setContentType("application/json");
            response.setCharacterEncoding("UTF-8");

            JSONObject json = new JSONObject();
            json.put("status", "success");
            json.put("cmoLocationText",
                    "<br/>Last Chased By : " + userName +
                            "<br/>On : " + date + "<br/>");

            response.getWriter().write(json.toString());
            response.getWriter().flush();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    /**
     * Write JSON error response for AJAX
     */
    private void writeErrorResponse(String message) {
        try {
            HttpServletResponse response = ServletActionContext.getResponse();
            response.setContentType("application/json");
            response.setCharacterEncoding("UTF-8");

            JSONObject json = new JSONObject();
            json.put("status", "error");
            json.put("message", message);

            response.getWriter().write(json.toString());
            response.getWriter().flush();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
